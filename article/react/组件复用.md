## 组件复用

#### 1. 代码复用

模块化是所有编程中都要用到的。模块化的主要作用有两个，一个是代码复用，另一个是分治，以减少心智负担。本文主要讨论代码复用。

代码复用即尽量减少相同代码的重复编写。

代码复用是代码可读性、可维护性和可扩展性的重要关注点。

开发者在实现应用时候，都有代码复用的需求。所有编程语言都有提供代码复用的支持，其实，函数本身就是代码复用的一种方式。

从模块化开发角度讲，代码复用的具体实现也依赖于模块的组织形式。比如，面向对象编程中，按类划分的模块，代码复用的基本单元就是类，复用的形式就是继承。函数式编程中，按函数划分的模块，代码复用的基本单元就是函数，复用的形式是高阶函数的调用。像GUI程序，可能会按照组件划分模块，其代码复用相对比较复杂，后面会详细说明。

代码复用的具体实现包括两个要素，第一，可复用代码如何组织，第二，如何使用可复用代码（包括如何控制可复用代码的行为和如何接受可复用代码的数据），即，可复用代码对外暴露什么形式的API。后面说明React组件的复用时候，都从这两个方面进行说明。

#### 2. React组件复用

这一小节的语境设定为使用React来开发前端应用。

在React组件开发中，我们需要考虑代码的复用。由于我们以组件为基本单元，那么需要考虑的问题是，如何复用组件。

那么如何复用组件呢？更具体一点，首先需要考虑两点，对于我们要实现的功能来说：

1. 哪些是通用的代码？哪些是非通用的代码？
2. 通用代码和非通用代码之间的关系是什么？

当我们能够明确地把代码划分为通用和非通用两部分，并且明确他们之间的关系时候，就可以后面的开发了。

对于大部分开发需求，有两种类型的通用和非通用代码划分：

1. 通用代码：状态逻辑；非通用代码：视图
	
	比如，react-redux中的connect，它负责处理的通用逻辑就是状态逻辑，包括订阅store中的数据和传递给子组件。
	
2. 通用代码：状态逻辑和部分视图；非通用代码：局部视图

	比如，ant-design中的Modal组件，负责处理通用代码是状态逻辑，即Modal的开关。除此之外，关闭按钮，确认、取消按钮也是Modal要考虑的部分。而非通用的代码即定制的视图是Modal的Children。另一个例子是layout组件，这种组件通常没有状态逻辑。

依照上述说明想好如何划分组件的通用代码和非通用代码之后，我们还要考察通用代码和非通用代码之间的关系。通常通用代码和非通用代码之间的关系有[两种类型](https://react.docschina.org/docs/composition-vs-inheritance.html)：

1. 包含关系，即非通用代码是通用代码的children（比如layout）
2. 特例关系，及定制化组件是通用组件的特例。这时候我们使用通用代码时候一般是通过传递props或者调用组件方法来实现需求的。

区分了通用代码和非通用代码，并且明确了两者之间的关系后，就可以开始实现我们的组件了。实现组件时候，使用React，我们有多种组件复用方式，即组织通用代码的方式。我们应该合理使用这些技术来实现我们的组件。

有3种主要的组件复用技术（还有不推荐的mixin技术和继承的方法）：

1. 高阶组件
2. render props
3. hook

其中hook主要是为了在函数式React组件中复用状态逻辑而提供的API支持，如果你的需求的通用和非通用代码划分是按照第一种方式的话，这种技术是实现需求的首选。它不适用于按第二种方式划分通用和非通用代码的需求。

下面主要说明高阶组件和render props技术。

> 高阶组件（HOC）是 React 中用于复用组件逻辑的一种高级技巧。HOC 自身不是 React API 的一部分，它是一种基于 React 的组合特性而形成的设计模式。 -- React官方文档

render props也是一样。

对于大部分需求，这两种技术是通用的。你可以选择使用前者或者后者，没有本质区别。

那么如何使用这两种技术实现相关的需求呢？我们需要考虑下面两个问题

1. 如何组织通用代码（即可复用代码）
	
	高阶组件的通用代码实现在高阶组件（一个函数）返回的那个组件中，高阶组件返回一个新的组件，是对传入的组件的包装。通用的代码都在这个返回的组件中实现，包括状态逻辑和可能的部分视图。对于状态逻辑，高阶组件会通过props传递给作为参数传递进来的子组件中，而作为非通用代码的局部视图，则会在合适的时机和合适的位置进行渲染
	
	使用render props技术的话，通用代码实现在通用组件中。状态逻辑实现在通用组件中，状态通过调用 render prop传递给使用该可复用组件的业务组件，作为非通用代码的局部视图，即render prop也会在合适时机和合适的位置进行渲染。

2. 如何使用通用代码（即可复用代码）

	高阶组件支持传入一个待包装组件和一系列配置参数。配置参数用来控制包装行为。待包装组件通过从props中获取高阶组件传过来的状态数据。
	
	render props技术支持我们给通用组件传递一些参数来控制通用逻辑的定制。而状态数据是传递给通用组件的render prop组件中通过props来获取。

#### 3. 程序开发步骤

从组件复用角度，我们使用React开发程序时候，可以遵循下列步骤

1. 需求分析，确定组件划分，找出哪些是通用代码，哪些是非通用代码，两者之间关系是什么（两者之间的关系决定了我们应该让通用代码暴露什么形式的接口）
2. 确定代码复用粒度，看通用的代码中只是包含状态逻辑还是也包含一些视图
3. 确定代码复用技术，开始开发。如果只是状态逻辑复用，建议使用hook抽象出通用逻辑。如果还有一些通用视图，则使用高阶函数或者render props技术都可以，当然，高阶组件和render props中的通用状态逻辑也可以使用hook来组织。另外不管使用高阶组件还是render props来组织通用代码，整个项目最好只使用一种形式，便于阅读。
